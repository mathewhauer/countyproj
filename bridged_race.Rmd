---
output: 
  pdf_document:
    number_sections: true
    citation_package: natbib
    keep_tex: true
    fig_caption: true
    latex_engine: pdflatex
    template: LATEX/svm-latex-ms.tex
title: "U.S. County level probabilistic population projections by age, sex, and race for the period 2015-2065"
thanks: "The data and code that supports this analysis are available in the supplementary materials."
author:
- name: Mathew E. Hauer ^1^*
  affiliation: University of Georgia

abstract: "I provide county-level population projections by age, sex, and race in five-year intervals for the period 2015-2065 for 3,136 counties. Using historic U.S. census data in temporally rectified county boundaries and race groups for the period 1990-2015, I calculate cohort-change ratios (CCRs) and cohort-change differences (CCDs) for eighteen five-year age groups (0-85+), two sex groups (Male and Female), and four race groups (White NH, Black NH, Other NH, Hispanic) in over 3,000 U.S counties. I then project these CCRs/CCDs using Unobserved Components Models as inputs into leslie matrix population projection models for a blended CCD/CCR population projection. My ex-post facto evaluations using three race groups (White, Black, Other) on the 1969-2000 base period evaluated at 2005, 2010, and 2015 demonstrate confidence in the accuracy of the projections. These data have numerous potential uses and can serve as inputs for addressing questions involving sub-national demographic change in the United States."
keywords: "Population projections; subnational; demographic change; cohort-change ratios"
date: "`r format(Sys.time(), '%B %d, %Y')`"
geometry: margin=1in
#fontfamily: mathpazo
fontsize: 12pt
spacing: double
bibliography: LATEX/mybibfile.bib
biblio-style: apsr
# use apsr or nature
header-includes:
- \usepackage[all]{nowidow}
- \usepackage{rotating}
- \usepackage{amsmath}
#- \usepackage{lineno}
#- \linenumbers


---
\* Corresponding author. hauer\@uga.edu. p: 706-542-9369.

^1^ Carl Vinson Institute of Government, University of Georgia. 201 N. Milledge Ave. Athens, GA USA 30602.



\newpage

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(knitr)
read_chunk('SCRIPTS/000-Libraries.R')
read_chunk('SCRIPTS/001-basedataload.R')
read_chunk('SCRIPTS/001-fipscodes.R')
read_chunk('SCRIPTS/001-readevalproj.R')
# read_chunk('SCRIPTS/004-Figure1.R')
# read_chunk('SCRIPTS/005-NonhumanDataLoad.R')
# read_chunk('SCRIPTS/006-Figure2.R')
# read_chunk('SCRIPTS/007-figure3a_xTFRAfrica.R')
# read_chunk('SCRIPTS/007-figure3b_historicbTFR.R')
# read_chunk('SCRIPTS/007-figure3c_incomexTFR.R')
# read_chunk('SCRIPTS/007-figure3_combined.R')
# read_chunk('SCRIPTS/008-suppfig1_uscountyxTFR.R')
# read_chunk('SCRIPTS/009-suppfig2.R')
# read_chunk('SCRIPTS/010-suppfig3.R')
```

```{r libraries, include=FALSE}
```

```{r evalbasedata, include=FALSE}
```

```{r fipscodes, include=FALSE}
```


```{r readevalproj, include=FALSE}
```


# BACKGROUND & SUMMARY

Population projections have a long history in the social and physical sciences as a means of examining demographic change, planning for the future, and to inform decision making in a variety of applications [@smith2006state; @passel2008us; @hebert2003alzheimer; @hales2002potential; @hauer2016millions; @gerland2014; @colby2017projections]. 

Producing high-quality, highly-detailed population projections is a challenging endeavor and no rigourous set of U.S. sub-national projections by age, sex, and race currently exists. With such a large need for sub-national projections and to better understand the changing demographics of the U.S. population, I sought to produce such a set of high-quality, highly-detailed projections and make both the R code and subsequent projections available for dissemination with a wide audience. Here, I present age-sex-race specific population projections for all U.S. counties and their uncertainty, an ex-post facto evaluation of the projection methodology, and details on the calculations of these projections. I generate these projections using a historic time series of population estimates for the period 1990-2016 [@wonder2016bridged] in temporally rectified county boundaries and race groupings using leslie matrices populated by cohort-change ratios (CCRs) [@baker2017cohort] and cohort-change differences (CCDs) projected through the use of Unobserved Component Models (UCMs) [@harvey1990forecasting] in a combined additive/multiplicative model.

To ensure quality projections, I employ the use of ex-post-facto evaluations of the projection accuracy for three variant models: purely additive with CCDs, purely multiplicative with CCRs, and a blended model with CCDs in areas projected to grow and CCRs in areas projected to decline. I report the accuracy, bias, and uncertainties associated with these variants using absolute percent error, algebraic percent error, and the number of observations where the observed population is within the 80th percentile projection interval. Overall, the errors reported here are on par with or better than deterministic cohort-component population projection models undertaken at the sub-national leveland with Bayesian population projection models undertaken at various national and sub-national scales [@smith2003evaluation; @wilson2016evaluation; @smith1997further; @rayer2008population; @wilson2005recent; @booth2006demographic; @wilson2012forecast;@raftery2012bayesian; @boyle2010projection; @daponte1997bayesian; @lutz1996probabilistic].

These projections, like all projections, involve the use of assumptions about future events that may or may not occur. Users of these projections should be aware that although the projections have been prepared with the use of standard methodologies, documentation of their creation, open-source computer code, and extensive evaluations of their accuracy and uncertainty, they may not accurately project the future population of a state, county, age, sex, or race group. The projections are based on historical trends and current estimates. These projections should be used only with full awareness of the inherent limitations of population projections in general and with knowledge of the procedures and assumptions described in this document. 

# METHODS

The cohort-component method is the most accepted methodology to produce population projections [@smith2006state; @preston2000demography]. The method makes use of all three population component processes (fertility, mortality, and migration) and applies them across varying population cohorts to arrive at a future population. Equation \ref{eq:cohortcomponent} outlines the basic structure of a cohort-component model.

\begin{equation}\label{eq:cohortcomponent}
P_{t+1} = P_t + B_t - D_t + M_{t,in} - M_{t,out}
\end{equation}

Where $P_t$ is the population at time $t$, $B_t$ is the births at time $t$, $D_t$ is the deaths at time $t$, and $M_{t, in/out}$ refers to in- or out-migration at time $t$.

Cohort-component requires data on each component process disaggregated by the dimensionality of the population to be projected. To produce detailed projections by age, sex, and race, detailed data age, sex, and race. Certain elements of these data can be difficult to obtain for complete national coverage of sub-national geographies. There is no comprehensive dataset of gross migration estimates by age, sex, and race for all U.S. counties. Birth and death data are typically obtained through the National Center of Health Statistics (NCHS) vital events registration databases [@martin2018births]. Birth data, however, are only available for counties with populations greater than 100k and Death data are only available for cells with more than 10 deaths [@tiwari2014impact]. These limitations surrounding fertility, mortality, and migration render a universal county-level population projection difficult, if not impossible, to complete using publicly available datasets.

An alternative to cohort-component is the Hamilton-Perry method [@swanson2010forecasting; @baker2017cohort ], which uses cohort-change ratios (CCRs) in place of components to project populations. The basic CCR equation is found in equation \ref{eq:ccr}.

\begin{eqnarray}\label{eq:ccr}
CCR_{t} & = & \frac {_nP_{x,t}} {_nP_{x-y,t-1}}\\
{_nP_{x+t}} & = & CCR_{t} \,\,  \cdot \,\, {_{n}P_{x-y,t}}
\end{eqnarray}

Where $_nP_{x,t}$ is the population aged $x$ to $x+n$ in time $t$ and $_nP_{x-y,t}$ is the population aged $x$ to $x+n-y$ in time $t$ where $y$ refers to the time difference between time periods. These CCRs are calculated for each age group $a$, for each sex group $s$, for each race group $r$, in each time period $t$, in county $c$. Thus to find the population of ten to fourteen year olds ($_5P_{10}$) in five years ($t+1$), we multiply the ratio of the population aged 10-14 in time $t$ ($_5P_{10,t}$) to the population aged 5-9 five-years prior in time $t-1$ ($_5P_{10-5,t-1}$) to the population aged 0-4 in time $t$ ($_5P_{10-5,t}$). ie, if we have 100 5-9 year olds five years ago and we now have 125 10-14 year olds and 90 5-9 year olds, we can expect the number of 10-14 year olds in 5 years to be (125/100 $\cdot$ 90 = 112.5).

Two age groups must have special consideration: the population aged 0-4 ($_5P_0$) and the population comprising the open-ended interval ($_{\infty}P_{85}$). The population aged 0-4 ($_5P_0$) must have special consideration since the preceding/proceeding age groups do not exist for these age groups. 


To project 0-4 year olds, I use the child-woman ratio (CWR)

\begin{eqnarray}\label{eq:cwr}
CWR_{t} & = & \frac{_5P_{0,t}}{_{45}W_{15,t}}\\
{_nP_{x+t}} & = & CWR_{t} \,\, \cdot \,\, {_{45}W_{15,t+1}}\nonumber
\end{eqnarray}

Where $_{45}W_{15}$ is the population of women in child-bearing ages 15-50.

To calculate the CCR for the open-ended age group,
\begin{eqnarray}\label{eq:ccr_open}
{_{\infty}CCR_{85,t}} & = & \frac{_{\infty}P_{85,t}}{_{\infty}P_{85-y,t-1}}\\
{_{\infty}P_{85+t}} & = & {_{\infty}CCR_{85,t}} \,\, \cdot \,\, {_{\infty}P_{85-y,t}}\nonumber
\end{eqnarray}

CCRs offer several advantages and disadvantages over the use of a cohort-component model. CCRs are considerably more parsimonious than cohort-component. Calculation of CCRs for use in population projections requires data as minimal as an age-sex distributions at two time periods -- data ubiquitous across multiple scales, countries, and time periods. However, this parsimony comes at a relatively steep price: CCRs can lead to impossibly explosive growth in long-range projections due to  the natural compounding of the ratios. Consider the growth currently occurring in McKenzie County, North Dakota (FIPS=38053) driven by the Shale oil boom. In 2010 McKenzie had a population of 6,360 that had ballooned to 12,792 by 2015, according to the Vintage 2016 population estimates from the US Census Bureau, with a CCR for the 20-24 year old population of 2.46 (416  to 1,027). Implementing a 50-year population projection using that CCR would create a projected population that is approximately 8,000 times larger ($2.46^{10}$) -- clearly an improbable number given the small, rural nature of its population.

## Cohort Change Differences
The implementation of CCRs naturally implies a multiplicative model, typically utilizing leslie matrices. It is possible, however, to implement an **additive** model by using the *difference* in population rather than the *ratio* of population.

\begin{eqnarray}\label{eq:ccd}
CCD_{t} & = & {_nP_{x,t}} \,\, - \,\, {_nP_{x-y,t-1}}\\
{_nP_{x+t}} & = & CCD_{t} \,\, + \,\, {_nP_{x-y,t}}\nonumber
\end{eqnarray}

Where $_nP_{x,t}$ is the population aged $x$ to $x+n$ in time $t$ and $_nP_{x-y,t}$ is the population aged $x$ to $x+n-y$ in time $t$ where $y$ refers to the time difference between time periods. These CCDs are calculated for each age group $a$, for each sex group $s$, for each race group $r$, in each time period $t$, in county $c$. Thus to find the population of ten to fourteen year olds ($_5P_{10}$) in five years ($t+1$), we add the differene of the population aged 10-14 in time $t$ ($_5P_{10,t}$) to the population aged 5-9 five-years prior in time $t-1$ ($_5P_{10-5,t-1}$) to the population aged 0-4 in time $t$ ($_5P_{10-5,t}$). ie, if we have 100 5-9 year olds five years ago and we now have 125 10-14 year olds and 90 5-9 year olds, we can expect the number of 10-14 year olds in 5 years to be (125-100 $+$ 90 = 115).

CCDs are just as parimonious as CCRs but have the additional advantage of producing linear growth rather than exponential growth. However, for areas experiencing population declines, CCDs have the potential of creating impossible negative populations through linear decline. A blended approach, using CCDs in areas projected to increase and CCRs in areas projected to decrease creates more utility in the projections at the cost of some accuracy (see \ref{table:1}).

## Projecting CCRs and CCDs

It is unlikely that CCRs/CCDs will remain unchanged over the projection horizon. To account for possible changes in CCRs/CCDs, I employ the use of an Unobserved Components Model (UCM) for forecasting equally spaced univariate time series data [@harvey1990forecasting]. UCMs decompose a time series into components such as trends, seasons, cycles, and regression effects and are designed to capture the features of the series that explain and predict its behavior. UCMs are similar to dynamic models in Bayesian time series forecasting[@west1996bayesian]. All projections were undertaken in R using the RUCM package. 

The basic structural model (BSM) is the sum of its stochastic components. Here I use an irregular, level, and a random error component and it can be described as:
  
\begin{eqnarray}
y_t  = \mu_t + \sum_{j=1}^{m} \beta_{j} x_{jt} + \epsilon_{t} \\
\varepsilon_t \sim i.i.d. \,\, N(0, \theta_{\epsilon}^2) \nonumber
\end{eqnarray}

Each of the model components are modeled separately with the random error $\varepsilon_t$ modeled as a sequence of independent, identically distributed zero-mean Gaussian random variables. $\sum_{j=1}^{m} \beta_{j} x_{jt}$ provides the contribution of the autoregressive component.

The level component is defined as:

\begin{eqnarray}
\mu_t = \mu_{t-1} + \xi_t \\
\xi_t \sim i.i.d. \,\, N(0, \theta_{\xi}^2) \nonumber
\end{eqnarray}

These equations specify a trend where the level $\mu_t$ vary over time, governed by the variance of the disturbance term $\xi_t$ in their equations. Here all individual CCRs/CCDs ($CCR_{iasr}$) over all  series are modelled (n=`r length(z)`) in individual UCMs.

Rather than use the prediction intervals output from the UCMs, I set the upper and lower bounds as the projected UCM plus or minus the 80th percentile based on the standard deviation of the original time series. 

For the CWRs, I projected the CWRs within a constrained forecast interval. CWRs are constrained to lie between ($a,b$). I limit CWRs such that each age/race/county combination are be constrained within the maximum/minimum of the time series such that $a=0.14$ (or a total fertility rate of approximately 1 [@hauer13; @schmertmann2017bayesian]) for all projections and $b=max(CWR_{arc})$. I then transform the data using a scaled logit transformation to map ($a,b$) to the whole real line:
  
\begin{equation}
y = log\big(\frac{x-a}{b-x}\big)
\end{equation}

Where $x$ is the original data and $y$ is the transformed data. 

The projected CCRs and CCDs are then input into Leslie matrices to create projected populations [@caswell2001matrix].

Equation \ref{eq:ccrleslie} describes the leslie matrices for CCRs and equation \ref{eq:ccdleslie} describes the leslie matrices for CCDs.

\begin{equation}\label{eq:ccrleslie}
\begin{bmatrix}
n_0 \\
n_1 \\
\vdots \\
n_{18}
\end{bmatrix}_{t+1}
=
  \begin{bmatrix}
0       & 0       	& 0       	& \dots 		& 0 & 0 \\
CCR_{0} & 0       	& 0       	& \dots 		& 0 & 0 \\
0       & CCR_{1} 	& 0       	& \dots 		& 0 & 0 \\
0       & 0       	& CCR_{2} 	& \dots  		& 0 & 0 \\
\vdots        & \vdots  		& \vdots 		& \ddots 	& 0 & 0 \\
0 & 0 & 0 & \dots & CCR_{16} & CCR_{17}
\end{bmatrix}
\,\, \cdot \,\,
\begin{bmatrix}
n_0 \\
n_1 \\
\vdots \\
n_{17}
\end{bmatrix}_{t}
\end{equation}


\begin{equation}\label{eq:ccdleslie}
\mathbf{T}
=
  \begin{bmatrix}
0       & 0       	& 0       	& \dots 		& 0 & 0 \\
CCD_{0} & 0       	& 0       	& \dots 		& 0 & 0 \\
0       & CCD_{1} 	& 0       	& \dots 		& 0 & 0 \\
0       & 0       	& CCD_{2} 	& \dots  		& 0 & 0 \\
\vdots        & \vdots  		& \vdots 		& \ddots 	& 0 & 0 \\
0 & 0 & 0 & \dots & CCD_{16} & CCD_{17}
\end{bmatrix}
\,\, + \,\,
\begin{bmatrix}
0       & 0       	& 0       	& \dots 		& 0 & 0 \\
n_{0} & 0       	& 0       	& \dots 		& 0 & 0 \\
0       & n_{1} 	& 0       	& \dots 		& 0 & 0 \\
0       & 0       	& n_{2} 	& \dots  		& 0 & 0 \\
\vdots        & \vdots  		& \vdots 		& \ddots 	& 0 & 0 \\
0 & 0 & 0 & \dots & n_{16} & n_{17}
\end{bmatrix}
\end{equation}

\begin{equation}
P_{t+1}
\equiv
\begin{bmatrix}
\sum_{j=1}^{n} \mathbf{T_{1,j}} \\
\sum_{j=1}^{n} \mathbf{T_{2,j}} \\
\vdots \\
\sum_{j=1}^{n} \mathbf{T_{17,j}}\nonumber
\end{bmatrix}
\end{equation}

The population aged 0-4 in time $t+1$ are projected by applying a 1.05 sex ratio at birth (SRB) to the projected children born of women of childbearing age $[15,50)$ in time $t+1$.

## DATA

Data used to project the populations consist of a single primary data source: the National Vital Statistics System U.S. Census Populations with Bridged Race Categories data set^[Data can be downloaded here: https://seer.cancer.gov/popdata/download.html]. These data harmoize racial classifications across disparate time periods to allow population estimates to be sufficiently comparable across space and time. All county boundaries are generally rectified as well. The National Center for Health Statistics bridge the 31 race categories used in Census 2000 and 2010 with the four race categories used in the 1977 Office of Management and Budget standards.

There are two primary bridged-race data sets. The first covers the time period 1969-2016 and utilizes three race groups: White, Black, and Other. The second covers the time period 1990-2016 and uses four race groups (White, Black, American Indian/Alaska Native, and Asian/Pacific Islander) as well as two origin groups (Hispanic and Non-Hispanic). Evaluation of the population projections makes use of the three race group dataset covering 1969-2016.

## Extra considerations

**Group quarters:** 
  All *resident* populations are projected in this modelling scheme such that the populations at launch year are equal to the total population minus the group quarters population. Group quarters populations at time $t$ are then added back into the resident population at time $t+1$.

**Miscellaneous**
In the event a UCM contained NA or infinite values or produced covariance matrices with values larger than 10,000,000, the projections were set to 0. Upper and Lower bounds of failed UCMs were set to 0. Any infinite, NA, or NAN CCR, CCD, or CWR was set to 0. Any projected negative populations are also set to 0.

# EVALUATIONS

To evaluate the projection accuracy, I use the base period 1980-2000 to project the population for eighteen age groups, two sexes, three races (White, Black, Other), and `r length(unique(paste0(z$STATE, z$COUNTY)))` counties for the projection period 2000-2015. I utilize an ex-post facto analysis at periods 2005, 2010, and 2015 using a pure CCD model (named ADD), a pure CCR model (named MULT), and blended model (named ADDMULT). The ADDMULT model utilizes CCDs if a county is projected to grow and CCRs if it is projected to decline. Blended models have been shown to outperform both purely linear or purely exponential models in simple extrapolation approaches to population projections [@wilson2016evaluation].

In keeping with demographic tradition [@hauer13; @booth2006demographic], I evaluate the projections using three primary statistics. To determine the overall accuray of the projections, I use Absolute Percent Errors (APE), to determine the bias of the projections I use the Algebraic Percent Error (ALPE), and to determine the accuracy of the uncertainty interval I evaluate the percentage of actual counts within the 80th percentage projection interval. In some places I have subsituted a Symmetric  Absolute Percent Error (SAPE) [@shcherbakov2013survey].

Equations \ref{eq:evals} describe the equations used to evaluate errors. $P_i$ refers to the projected value and $A_i$ refers to the actual, observed value.

\begin{eqnarray}\label{eq:evals}
APE & = & |\frac{P_i} {A_i}|\\
ALPE & = & \frac {P_i} {A_i}\\
SAPE & = & \frac{|(P_i - A_i)|} {(P_i + A_i)}
\end{eqnarray}


## Overall Errors


Table **1** reports the overall errors for the sum of the population in each of the subsequent states and counties. Overall the purely ADDITIVE model outperformed the purely MULTIPLICATIVE model, suggesting CCDs in this model could produce more accurate results compared to CCRs. It should also be noted that all model variants (ADD, MULT, and ADDMULT) have a tendency to over-project the overall population in the United States.

```{r TOTALeval, echo=FALSE, message=FALSE, warning=FALSE, results='asis', cache=TRUE, fig.cap = "\\label{tab:TOTALeval}"}
library(kableExtra)
eval_ucm_statetotal <- z %>%
  #mutate(RACE = substr(countyrace, 7,25))
  group_by(TYPE, YEAR) %>%
  dplyr::summarise(POPULATION = sum(POPULATION),
            A = sum(A),
            B = sum(B),
            C = sum(C),
            num = length(A)) %>%
  mutate(FLAG1 = if_else(is.na((A/POPULATION)-1), 0,(A/POPULATION)-1),
         FLAG2 = if_else(POPULATION>=B & POPULATION<=C,1,0),
         PRED= prettyNum(A, big.mark=",", scientific=FALSE),
         LOW = prettyNum(B, big.mark=",", scientific=FALSE),
         HIGH = prettyNum(C, big.mark=",", scientific=FALSE),
         APE = percent(abs(FLAG1)),
         ALPE = percent(FLAG1),
         in80percentile = percent(FLAG2/num),
         POPULATION = prettyNum(POPULATION, big.mark=",", scientific=FALSE)) %>%
  select(-num, -FLAG2, -in80percentile, -A, -B, -C, -FLAG1, -ALPE) %>%
  filter(!TYPE == "BASE")

kable(eval_ucm_statetotal, format='pandoc', caption="\\label{tab:TOTALeval}**Evaluation of overall total errors for the entire United States.**", digits = 4)
```

Table **2** reports the overall errors for the sum of the population in each of the counties. Here we can see that for the average county, the ADDITIVE and ADDMULT models produce similar APEs but the ADDMULT model tends to produce slightly lower APEs when compared to the purely ADD model. In all cases, the errors associated with the MULT model are greater than the ADD or ADDMULT varieties.

```{r COUNTY TOTAL eval, echo=FALSE, message=FALSE, warning=FALSE, results='asis', cache=TRUE}
library(kableExtra)
eval_ucm_cntytotal <- z %>%
  filter(!TYPE == "BASE") %>%
  group_by(STATE, COUNTY, YEAR, TYPE) %>%
  dplyr::summarise(POPULATION = sum(POPULATION),
                   A = sum(A),
                   B = sum(B),
                   C = sum(C),
                   num = length(A)) %>%
  mutate(FLAG1 = if_else(is.na((A/POPULATION)-1), 0,(A/POPULATION)-1),
         FLAG2 = if_else(POPULATION>=B & POPULATION<=C,1,0),
         in90percentile = FLAG2/num) %>%
  ungroup() %>%
  group_by(YEAR, TYPE) %>%
  dplyr::summarise(MAPE = quantile(abs(FLAG1), 0.5),
                   MALPE = quantile(FLAG1, 0.5),
                   in80percentile = sum(FLAG2)/length(FLAG2),
                    n = length(FLAG1)) %>%

  mutate(MAPE= percent(MAPE),
         MALPE = percent(MALPE),
         in80percentile = percent(in80percentile))

mapeeval<- eval_ucm_cntytotal %>%
  select(YEAR, TYPE, MAPE, n) %>%
  spread(YEAR, MAPE) %>%
  mutate(EVAL = "Median APE")
malpeeval <- eval_ucm_cntytotal %>%
  select(YEAR, TYPE, MALPE,n ) %>%
  spread(YEAR, MALPE) %>%
  mutate(EVAL = "Median ALPE")

eval80<- eval_ucm_cntytotal %>%
  select(YEAR, TYPE, in80percentile,n ) %>%
  spread(YEAR, in80percentile) %>%
  mutate(EVAL = "In 80th percentile")

table <- rbind(mapeeval, malpeeval) %>%
  rbind(., eval80) %>%
  select(TYPE, n, EVAL, "2005", "2010", "2015")

kable(table, caption="**Evaluation of overall errors for each county.**")

```



\autoref{county map} shows the absolute percent errors associated with the total population for the ADDMULT model in U.S. counties in 2015. Most states and counties see relatively low errors with the median APE of just 8.29% by 2015, however some isolated pockets of high errors do exist randomly distributed throughout the United States. Additionally, 94.8% of counties had observed population totals within the 80th percentile prediction interval with the ADDMULT model by 2015. This large number of counties could suggest that prediction bands at at the scale of population totals in counties could be too wide. 

```{r, echo=FALSE, , message=FALSE, warning=FALSE, cache=TRUE, paged.print=FALSE, fig.cap=paste("**Map of county errors of the total population in 2015 using the ADDMULT model.** Here I show the geographic distribution of absolute percent errors. Most states and counties have low error rates of the total population with isolated pockets of large errors. \\label{county map}"), results='asis'}
eval_ucm_cntytotal <- z %>%
  filter(!TYPE == "BASE") %>%
  group_by(STATE, COUNTY, GEOID, YEAR, TYPE) %>%
  dplyr::summarise(POPULATION = sum(POPULATION, na.rm=T),
                   A = sum(A, na.rm=T),
                   B = sum(B),
                   C = sum(C),
                   num = length(A)) %>%
  mutate(FLAG1 = if_else(is.na((A/POPULATION)-1), 0,abs((A/POPULATION)-1)),
         FLAG2 = if_else(POPULATION>=B & POPULATION<=C,1,0),
         in90percentile = FLAG2/num) %>%
  ungroup() %>%
  filter(YEAR == 2015,
         TYPE == "ADDMULT")%>%
  select(FLAG1, STATE, GEOID)

counties <- append_data(counties, eval_ucm_cntytotal, key.shp = "GEOID", key.data = "GEOID", ignore.duplicates = TRUE) 

US_cont <- counties %>% 
  subset(!STATEFP %in% c("02","15")) 

m_cont<- tm_shape(US_cont) +
  tm_polygons("FLAG1", 
              title = "APE", 
              palette = "YlOrBr", 
              breaks= c(-Inf, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, Inf),
              auto.palette.mapping = FALSE, 
              id = "GEOID", 
              #showNA = TRUE, 
              border.col = "gray50", 
              border.alpha =0.5,
              legend.is.portrait=FALSE
              #style ="jenks",
              #n = 8
  ) +
  tm_shape(states) +
  tm_borders(lwd=2, col="black", alpha = 0.5) +
  tm_layout(legend.position = c("left", "bottom"), 
            # legend.stack = "portrait",
            legend.text.size = 0.5,
            frame = FALSE)
m_cont

```


## Age Structure Error

Table **3** reports the overall errors for age groups at the county level. All three models produce similar APEs. For any given county, the average error is approximately 11%. Similar to the overall errors, the bias tends to be for over-projection of age groups as all of the ALPEs are positive.

```{r ages total, echo=FALSE, results='asis', message=FALSE, warning=FALSE, cache=TRUE, fig.cap=paste("**Evaluation of Age Group Errors.**\\label{ages total}")}

eval_ucm_agetotal <- z %>%
  filter(!TYPE == "BASE") %>%
  group_by(STATE, COUNTY, AGE, YEAR, TYPE) %>%
  dplyr::summarise(POPULATION = sum(POPULATION),
                   A = sum(A),
                   B = sum(B),
                   C = sum(C),
                   num = length(A)) %>%
  mutate(FLAG1 = if_else(is.na((A/POPULATION)-1), 0,(A/POPULATION)-1),
         FLAG2 = if_else(POPULATION>=B & POPULATION<=C,1,0),
         in90percentile = FLAG2/num) %>%
  ungroup() %>%
  group_by(YEAR, TYPE) %>%
  dplyr::summarise(MAPE = quantile(abs(FLAG1), 0.5),
                   MALPE = quantile(FLAG1, 0.5),
                   in80percentile = sum(FLAG2)/length(FLAG2),
                    n = length(FLAG2)) %>%
  # COUNTYnum = length(FLAG2)) %>%
  mutate(MAPE= percent(MAPE),
         MALPE = percent(MALPE),
         in80percentile = percent(in80percentile))
mapeeval<- eval_ucm_agetotal %>%
  select(YEAR, TYPE, MAPE, n) %>%
  spread(YEAR, MAPE) %>%
  mutate(EVAL = "Median APE")
malpeeval <- eval_ucm_agetotal %>%
  select(YEAR, TYPE, MALPE, n) %>%
  spread(YEAR, MALPE) %>%
  mutate(EVAL = "Median ALPE")
eval80<- eval_ucm_agetotal %>%
  select(YEAR, TYPE, in80percentile, n) %>%
  spread(YEAR, in80percentile) %>%
  mutate(EVAL = "In 80th percentile")

table <- rbind(mapeeval, malpeeval) %>%
  rbind(., eval80) %>%
  select(TYPE, n, EVAL, "2005", "2010", "2015")

kable(table, caption="**Evaluation of Age Group Errors.**", digits = 4)
```



\autoref{ageexample} shows projected age structures in nine samples counties across three county types -- college counties, suburban counties, and retirement counties. In all three county types the age structures are preserved in the projections. All three county types exhibit differing age structures with important considerations. For college counties, the college-age population (those aged 15-24) do not age in place within those communities. The large population peaks in those counties show great in-migration at the college ages and then great out-migration afterwards. In suburban counties, a "double hump" age structure is typically present with large numbers of both adolescents and middle-aged adults. Most twenty-somethings either cannot afford to live in affluent suburban areas, move away for school or work, or do not have the family reasons for living there. Retirement communities are often identified by the large numbers of populations over the age of 55. 

```{r, echo=FALSE, results='asis', cache=TRUE, message=FALSE, warning=FALSE,  fig.cap=paste("**Age structures of various county types.** I compare the projected age structures to the observed age structures in nine counties across three county types using the ADD/MULT model. (a) demonstrates counties with major universities, (b) demonstrates sample suburban counties, and (c) demonstrates sample retirement counties. All three county types have age structures largely preserved despite widely different age structures.\\label{ageexample}")}
collegecampuses<- z[which(z$GEOID %in% c("13059","36109", "42027")),]
collegecampuses <- collegecampuses %>%
  group_by(GEOID, NAME, state, AGE, TYPE, YEAR) %>%
  dplyr::summarise(A = sum(A),
                   POPULATION=sum(POPULATION)) %>%
  ungroup()%>%
  mutate(CNTYNAME = paste0(NAME, ", ",state),
         AGE = AGE*5-5) %>%
  filter(YEAR %in% c(2005,2015)) %>%
  mutate(YEAR = as.factor(YEAR))
suburban<- z[which(z$GEOID %in% c("18057","47187", "13117")),]
suburban <- suburban %>%
  group_by(GEOID, NAME, state, AGE, TYPE, YEAR) %>%
  dplyr::summarise(A = sum(A),
                   POPULATION=sum(POPULATION)) %>%
  ungroup()%>%
  mutate(CNTYNAME = paste0(NAME, ", ",state),
         AGE = AGE*5-5) %>%
  filter(YEAR %in% c(2005,2015)) %>%
  mutate(YEAR = as.factor(YEAR))

retirement<- z[which(z$GEOID %in% c("26089","05005", "37175")),]
retirement <- retirement %>%
  group_by(GEOID, NAME, state, AGE, TYPE, YEAR) %>%
  dplyr::summarise(A = sum(A),
                   POPULATION=sum(POPULATION)) %>%
  ungroup()%>%
  mutate(CNTYNAME = paste0(NAME, ", ",state),
         AGE = AGE*5-5) %>%
  filter(YEAR %in% c(2005,2015)) %>%
  mutate(YEAR = as.factor(YEAR))


figure_age = function(x, title){
  a<-ggplot(x) +
    geom_line(data = x[which(x$TYPE =="ADDMULT"),], aes(x = AGE, y=A, colour = YEAR, linetype= "dotted")) +
    geom_line(data = x[which(x$TYPE =="ADDMULT"),], aes(x = AGE, y=POPULATION, colour = YEAR, linetype= "solid")) +
    theme_bw() +
    scale_color_manual(labels = c("2005", "2015"), values = c("red", "blue")) +
    scale_linetype_manual(name = "",labels = c("CCR/CWR", "Observed"), values=c("dashed", "solid"))+
    labs(x = "Age Group",
         y = "Population",
         title = paste0(title)) +
    facet_grid(. ~ CNTYNAME, scales = "fixed")
  return(a)
}
campuses<- figure_age(collegecampuses, "Counties with large college campuses")
suburbs<- figure_age(suburban, "Suburban counties")
retirements<-   figure_age(retirement, "Retirement counties")

prow <- plot_grid(campuses + theme(legend.position="none"),
                  suburbs + theme(legend.position="none"),
                  retirements + theme(legend.position="none"),
                  labels ="auto", ncol = 1
)
legend <- get_legend(campuses)
plot_grid(prow, legend, rel_widths = c(2.5, 0.5))


```


\autoref{agestructures} shows the Algebraic Percent Errors by age group for all three evaluation periods. For every age below 60, the ADD and ADD/MULT models produce lower ALPEs, but for age groups over 60, the Mult model produces lower ALPEs. This could be reflective of mortality being the dominant population process for older age populations and is especially pronounced in the 85+ age group. Here, the 50th percentile ALPE for ADD and ADD/MULT is approximately 20% while the Mult model is just under 10%. Future projections could blend the two together and use CCRs for the open-ended age interval.

```{r,echo=FALSE, results='asis', cache=TRUE, message=FALSE, warning=FALSE,  fig.cap=paste("**Algebraic Percent Errors by age group.** I plot the 50th percentile Algebraic Percent Error (ALPE) by age group for 2005, 2010, and 2015.\\label{agestructures}")}
eval_ucm_agetotal <- z %>%
  filter(!TYPE == "BASE") %>%
  group_by(STATE, COUNTY, AGE, YEAR, TYPE) %>%
  dplyr::summarise(POPULATION = sum(POPULATION),
                   A = sum(A),
                   B = sum(B),
                   C = sum(C),
                   num = length(A)) %>%
  mutate(FLAG1 = if_else(is.na((A/POPULATION)-1), 0,(A/POPULATION)-1),
         FLAG2 = if_else(POPULATION>=B & POPULATION<=C,1,0),
         in90percentile = FLAG2/num) %>%
  ungroup() %>%
  group_by(AGE, TYPE) %>%
  dplyr::summarise(MAPE = quantile(abs(FLAG1), 0.5),
                   MALPE = quantile(FLAG1, 0.5),
                   in80percentile = sum(FLAG2)/length(FLAG2),
                   n = length(FLAG2)) %>%
  ungroup()%>%
  mutate(AGE = case_when(
    AGE == 1 ~ 0,
    AGE == 2 ~ 5,
    AGE == 3 ~ 10,
    AGE == 4 ~ 15,
    AGE == 5 ~ 20,
    AGE == 6 ~ 25,
    AGE == 7 ~ 30,
    AGE == 8 ~ 35,
    AGE == 9 ~ 40,
    AGE == 10 ~ 45,
    AGE == 11 ~ 50,
    AGE == 12 ~ 55,
    AGE == 13 ~ 60,
    AGE == 14 ~ 65,
    AGE == 15 ~ 70,
    AGE == 16 ~ 75,
    AGE == 17 ~ 80,
    AGE == 18 ~ 85
  ))
  #        MALPE = percent(MALPE),
  #        in80percentile = percent(in80percentile))

ggplot(data=eval_ucm_agetotal, aes(group = TYPE)) +
  geom_line(aes(x=AGE, y =MALPE, linetype=TYPE, col=TYPE)) +
  geom_hline(yintercept=0) +
  theme_bw()
```



## Race Errors

\autoref{raceerrors} reports the ALPE and the APE distribution by race group for all counties. The White race group tends to have the lowest errors associated with the proejctions, followed by Black, and then Other.


```{r, echo=FALSE, results='asis', cache=TRUE, , message=FALSE, warning=FALSE, fig.cap=paste("**Race group errors. (a) shows the Algebraic Percent Errors for all three methods and (b) shows the APE distribution of errors.** \\label{raceerrors}")}
eval_ucm_agetotal <- z %>%
  filter(!TYPE == "BASE") %>%
  group_by(STATE, COUNTY, RACE, YEAR, TYPE) %>%
  dplyr::summarise(POPULATION = sum(POPULATION),
                   A = sum(A),
                   B = sum(B),
                   C = sum(C),
                   num = length(A)) %>%
  mutate(FLAG1 = if_else(is.na((A/POPULATION)-1), 0,(A/POPULATION)-1),
         FLAG2 = if_else(POPULATION>=B & POPULATION<=C,1,0),
         in90percentile = FLAG2/num) %>%
  ungroup()
figure_race = function(x){
  a<-ggplot() +
    geom_density(data=x[which(x$YEAR == 2015),], aes(x=FLAG1, colour = RACE, fill = RACE), adjust=1.5, lwd=1, alpha=.20) +
    scale_color_manual(name="Race",labels = c("White", "Black", "Other"), values = c("red", "Green", "Blue")) +
    geom_vline(xintercept=0) +
    theme_bw() +
    guides(fill=FALSE) +
    #scale_color_manual(name="TEST",labels = c("White", "Black", "Other"), values = c("red", "blue", "Green")) +
    xlim(-0.5,0.5) + 
    labs(x='Algebraic Percent(error)',
         y='Density') +
    facet_grid(. ~ TYPE, scales = "fixed")
  return(a)
}
figure_race2 = function(x){
  a<-ggplot() +
    geom_density(data=x[which(x$YEAR == 2015),], aes(x=abs(FLAG1), colour = RACE, fill = RACE), adjust=1.5, lwd=1, alpha=.20) +
    scale_color_manual(name="Race",labels = c("White", "Black", "Other"), values = c("red", "Green", "Blue")) +
    geom_vline(xintercept=0) +
    theme_bw() +
    guides(fill=FALSE) +
    #scale_color_manual(name="TEST",labels = c("White", "Black", "Other"), values = c("red", "blue", "Green")) +
    xlim(0,0.5) + 
    labs(x='Absolute Percent(error)',
         y='Density') +
    facet_grid(. ~ TYPE, scales = "fixed")
  return(a)
}
panel1 <- figure_race(eval_ucm_agetotal)
panel2 <- figure_race2(eval_ucm_agetotal)

prow <- plot_grid(panel1 + theme(legend.position="none"),
                  panel2 + theme(legend.position="none"),
                  labels ="auto", ncol = 1
)
legend <- get_legend(panel1)
plot_grid(prow, legend, rel_widths = c(2.5, 0.5))
```

## Age, Sex, Race joint errors

Finally, I show the joint errors associated with all possible Age/Sex/Race/County combinations. Here the average error for any given ASRC combination (such as Black Females aged 20-24 in Lincoln County NV) are approximately 11-12% for all three methods after 15 years. In contrast to the confidence bounds being too wide when discussing the overal total populations in counties, when examining any given ASRC combination it appeasrs that the projection intervals are too narrow for all three methods. Between two-thirds and three-fourths of observed populations fall within the 80th percentile.

```{r ASRC total, echo=FALSE, results='asis', message=FALSE, warning=FALSE, fig.cap=paste("**Evaluation of Age Group Errors.**\\label{ages total}")}

eval_ucm_cntytotal <- z %>%
  # filter(!TYPE == "BASE") %>%
  #group_by(STATE, COUNTY,SEX, RACE, AGE, YEAR, TYPE) %>%
   # dplyr::summarise(POPULATION = sum(POPULATION, na.rm=T),
   #                  A = sum(A, na.rm=T),
   #                  B = sum(B, na.rm=T),
   #                  C = sum(C, na.rm=T),
   #                  num = length(A)) %>%
  mutate(A= round(A, 6),
         #FLAG1 = abs(A-POPULATION)/abs(A+POPULATION),
    FLAG1 = if_else(is.na(abs((A-POPULATION))/(A+POPULATION)), 0,abs((A-POPULATION))/(A+POPULATION)),
         FLAG2 = if_else(POPULATION>=B & POPULATION<=C,1,0)) %>%
  #ungroup() %>%
  #na.omit %>%
  group_by(YEAR, TYPE) %>%
  dplyr::summarise(SMAPE = quantile(abs(FLAG1), 0.5),
                   #MALPE = quantile(FLAG1, 0.5),
                   in80percentile = sum(FLAG2)/length(FLAG2),
                   num = length(FLAG2)) %>%
  # COUNTYnum = length(FLAG2)) %>%
  mutate(SMAPE= percent(SMAPE),
         #MALPE = percent(MALPE),
         in80percentile = percent(in80percentile))

mapeeval<- eval_ucm_cntytotal %>%
  select(YEAR, TYPE, SMAPE, num) %>%
  spread(YEAR, SMAPE) %>%
  mutate(EVAL = "Median SAPE")


eval80<- eval_ucm_cntytotal %>%
  select(YEAR, TYPE, in80percentile, num) %>%
  spread(YEAR, in80percentile) %>%
  mutate(EVAL = "In 80th percentile")

table <- rbind(mapeeval, eval80) %>%
  #rbind(., eval80) %>%
  select(TYPE, num, EVAL, "2005", "2010", "2015")

kable(table, caption="**Evaluation of Age/Sex/Race/County joint Errors.**", digits = 4)
```

#PROJECTIONS

Projections will go here.
